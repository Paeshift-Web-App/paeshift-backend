<!-- templates/chat_room.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Job Chat & Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var jobId = "{{ job_id }}";
        var chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + jobId + '/');
        var locationSocket = new WebSocket('ws://' + window.location.host + '/ws/jobs/' + jobId + '/location/');
        

        function startHeartbeat(socket) {
            setInterval(() => {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ "type": "heartbeat" }));
                }
            }, 30000);
        }

        function reconnectWebSocket(socketType) {
            setTimeout(() => {
                if (socketType === "chat") {
                    console.log("Reconnecting Chat WebSocket...");
                    connectChatSocket();
                } else if (socketType === "location") {
                    console.log("Reconnecting Location WebSocket...");
                    connectLocationSocket();
                }
            }, 5000);
        }

        function connectChatSocket() {
            chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + jobId + '/');

            chatSocket.onopen = function() {
                console.log("Chat WebSocket Connected");
                startHeartbeat(chatSocket);
            };

            chatSocket.onmessage = function(event) {
                var data = JSON.parse(event.data);
                var messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML += '<p><b>' + data.sender + ':</b> ' + data.message + '</p>';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };

            chatSocket.onclose = function(event) {
                console.error("Chat WebSocket Disconnected", event);
                reconnectWebSocket("chat");
            };
        }

        function connectLocationSocket() {
            locationSocket = new WebSocket('ws://' + window.location.host + '/ws/jobs/' + jobId + '/location/');

            locationSocket.onopen = function() {
                console.log("Location WebSocket Connected");
                startHeartbeat(locationSocket);
            };

            locationSocket.onclose = function(event) {
                console.error("Location WebSocket Disconnected", event);
                reconnectWebSocket("location");
            };
        }

        function sendMessage() {
            if (chatSocket.readyState === WebSocket.OPEN) {
                var input = document.getElementById("messageInput");
                var message = input.value.trim();

                if (message !== "") {
                    chatSocket.send(JSON.stringify({ "message": message }));
                    input.value = "";
                }
            } else {
                console.error("WebSocket is closed, cannot send message.");
            }
        }

        function loadChatHistory() {
            fetch('/chat/api/messages/' + jobId + '/')
            .then(response => response.json())
            .then(data => {
                var messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML = "";
                data.forEach(msg => {
                    messagesDiv.innerHTML += '<p><b>' + msg.sender + ':</b> ' + msg.content + '</p>';
                });
            })
            .catch(error => console.error("Error loading chat history:", error));
        }

        window.onload = function() {
            loadChatHistory();
            connectChatSocket();
            connectLocationSocket();
            setTimeout(initMap, 500);
        };

        function initMap() {
            var mapContainer = document.getElementById("map");
            if (!mapContainer) {
                console.error("Map container not found.");
                return;
            }

            var map = L.map('map').setView([51.505, -0.09], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            var markers = {};

            locationSocket.onmessage = function(event) {
                var data = JSON.parse(event.data);
                var key = data.user;

                if (markers[key]) {
                    markers[key].setLatLng([data.latitude, data.longitude]).bindPopup(data.address).openPopup();
                } else {
                    markers[key] = L.marker([data.latitude, data.longitude]).addTo(map).bindPopup(data.address).openPopup();
                }
            };
        }

        function shareLocation() {
            navigator.geolocation.getCurrentPosition(position => {
                locationSocket.send(JSON.stringify({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                }));
            }, error => {
                alert("Location access denied. Please enable location services.");
            });
        }
    </script>
</head>
<body>
    <h2>Chat Room for Job #{{ job_id }}</h2>
    <div id="messages" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;"></div>
    <input id="messageInput" type="text" style="width: 80%;">
    <button onclick="sendMessage()">Send</button>
    
    <h2>Client Locations</h2>
    <div id="map" style="height: 500px; width: 100%;"></div>
    <button onclick="shareLocation()">Share My Location</button>
</body>
</html>
