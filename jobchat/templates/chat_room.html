<!DOCTYPE html>
<html lang="en">
<head>
    <title>Job Chat & Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <h2>Chat Room for Job #{{ job_id }}</h2>
    <div id="messages" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;"></div>
    <input id="messageInput" type="text" style="width: 80%;">
    <button onclick="sendMessage()">Send</button>

    <h2>Client Locations</h2>
    <div id="map" style="height: 500px; width: 100%;"></div>

    <script>
        const jobId = "{{ job_id }}";
        let chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${jobId}/`);
        let locationSocket = new WebSocket(`ws://${window.location.host}/ws/jobs/${jobId}/location/`);

        chatSocket.onmessage = function(event) {
            let data = JSON.parse(event.data);
            let sender = data.sender || "Anonymous";
            let message = data.message || "[No message]";
            document.getElementById('messages').innerHTML += `<p><b>${sender}:</b> ${message}</p>`;
        };

        function sendMessage() {
            let input = document.getElementById("messageInput");
            let message = input.value.trim();
            if (message) {
                chatSocket.send(JSON.stringify({ "message": message }));
                input.value = "";
            }
        }

        let map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markers = {};

        locationSocket.onmessage = function(event) {
            let data = JSON.parse(event.data);
            let key = data.user;
            markers[key] = L.marker([data.latitude, data.longitude]).addTo(map).bindPopup(data.address).openPopup();
        };

        setInterval(() => {
            navigator.geolocation.getCurrentPosition(position => {
                locationSocket.send(JSON.stringify({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                }));
            });
        }, 5000);  // Send every 5 seconds (heartbeat)
    </script>
</body>
</html>
