<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Job</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Font Awesome for icons -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    .errors {
      color: red;
      font-size: 0.9em;
    }
    .location-icon {
      margin-left: -30px;
      position: relative;
      top: 8px;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1>Create Job Request</h1>
    <form id="jobForm">
      <!-- Part 1: Main Details -->
      <div class="form-group">
        <label for="jobtitle">Job Title</label>
        <input type="text" class="form-control" id="jobtitle" name="title" placeholder="Write a title for your job (30 letters max)" required>
      </div>
      <div class="form-group">
        <label for="jobLocation">Job Location</label>
        <div class="input-group">
          <input type="text" class="form-control" id="jobLocation" name="location" placeholder="Where will the job take place?" required>
          <div class="input-group-append">
            <span class="input-group-text">
              <i class="fas fa-map-marker-alt"></i>
            </span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="jobIndustry">Job Industry</label>
        <select class="form-control" id="jobIndustry" name="industry" required>
          <option value="">Select Job Industry</option>
        </select>
      </div>
      <div class="form-group">
        <label for="jobSubCategory">Job Subcategory</label>
        <select class="form-control" id="jobSubCategory" name="subcategory" required>
          <option value="">Select Subcategory</option>
        </select>
      </div>
      <div class="form-group">
        <label for="jobRate">Job Rate per Hour</label>
        <input type="number" class="form-control" id="jobRate" name="rate" required>
      </div>
      <div class="form-group">
        <label for="noOfApplicants">Applicants Needed</label>
        <input type="number" class="form-control" id="noOfApplicants" name="applicants_needed" required>
      </div>
      
      <!-- Part 2: Timeline & Scope -->
      <div class="form-group">
        <label for="jobType">Job Type</label>
        <select class="form-control" id="jobType" name="job_type" required>
          <option value="">Select Job Type</option>
          <option value="single_day">A Day Job</option>
          <option value="multiple_days">Multiple Days</option>
        </select>
      </div>
      <div class="form-group">
        <label for="shiftType">Shift Type</label>
        <select class="form-control" id="shiftType" name="shift_type" required>
          <option value="">Select Shift Type</option>
          <option value="day_shift">Day Shift</option>
          <option value="night_shift">Night Shift</option>
        </select>
      </div>
      <div class="form-group">
        <label for="jobDate">Job Date</label>
        <input type="date" class="form-control" id="jobDate" name="date" required>
      </div>
      <div class="form-group">
        <label for="startTime">Start Time</label>
        <input type="time" class="form-control" id="startTime" name="start_time" required>
      </div>
      <div class="form-group">
        <label for="endTime">End Time</label>
        <input type="time" class="form-control" id="endTime" name="end_time" required>
      </div>
      <!-- Fixed hidden fields -->
      <input type="hidden" name="duration" value="2hrs">
      <input type="hidden" name="payment_status" value="Pending">
      
      <button type="submit" class="btn btn-primary">Proceed to Payment</button>
    </form>
    <div id="message" class="mt-3"></div>
  </div>

  <!-- Axios CDN -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // Wait for the DOM to load
    document.addEventListener("DOMContentLoaded", function () {
      const industrySelect = document.getElementById("jobIndustry");
      const subcategorySelect = document.getElementById("jobSubCategory");
      const jobForm = document.getElementById("jobForm");
      const messageDiv = document.getElementById("message");
      let allSubcategories = [];

      // Fetch industries from the backend
      axios.get("http://127.0.0.1:8000/jobs/job-industries/")
        .then(function(response) {
          response.data.forEach(industry => {
            const option = document.createElement("option");
            option.value = industry.id;
            option.textContent = industry.name;
            industrySelect.appendChild(option);
          });
        })
        .catch(function(error) {
          console.error("Error fetching industries:", error);
          messageDiv.textContent = "Error loading industries.";
        });

      // Fetch subcategories from the backend
      axios.get("http://127.0.0.1:8000/jobs/job-subcategories/")
        .then(function(response) {
          allSubcategories = response.data;
        })
        .catch(function(error) {
          console.error("Error fetching subcategories:", error);
          messageDiv.textContent = "Error loading subcategories.";
        });

      // Filter subcategories when industry changes
      industrySelect.addEventListener("change", function () {
        const selectedIndustryId = this.value;
        // Clear subcategory dropdown
        subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
        const filtered = allSubcategories.filter(sub => String(sub.industry_id) === selectedIndustryId);
        filtered.forEach(subcategory => {
          const option = document.createElement("option");
          option.value = subcategory.id;
          option.textContent = subcategory.name;
          subcategorySelect.appendChild(option);
        });
      });

      // Handle form submission
      jobForm.addEventListener("submit", function(e) {
        e.preventDefault();
        // Convert the form data to an object
        const formData = new FormData(jobForm);
        const jobData = {};
        formData.forEach((value, key) => {
          jobData[key] = value;
        });
        // Ensure numeric values are numbers
        jobData.rate = Number(jobData.rate);
        jobData.applicants_needed = Number(jobData.applicants_needed);
        
        console.log("Job data:", jobData);
        // POST to the job creation endpoint
        axios.post("http://127.0.0.1:8000/create-job", jobData, { headers: { "Content-Type": "application/json" } })
          .then(function(response) {
            messageDiv.textContent = "Job Created Successfully! ID: " + response.data.job_id;
          })
          .catch(function(error) {
            console.error("Job creation error:", error);
            messageDiv.textContent = "Job Creation Failed!";
          });
      });
    });
  </script>
</body>
</html>
